# dccn-logmgr

Wrap Elasticsearch API to provide log search service

# Note

Have fun and enjoy it, let's go!

# API Specification

* GetLogCountByAppId

LogAppCountRequest

|Parameter | Type |Need| Description |
|:-----|:-----|:-----|:-----|
|req_id|string|optional|Unique request id,stored in gRPC metadata field ankr_req_id |
|app_id|string|required|AppID generated and managed by appmgr|
|keywords|[]string|optional|keywords log item contains,such as error|
|start_time|uint64|required|start time of log, measured by second from UTC(zero time zone)|
|end_time|uint64|required|end time of log, measured by second from UTC(zero time zone)|
|is_test|bool|optional|when true, test API whether it is available or not|


LogAppCountResponse

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|required|Corresponding to request, default value Unknown|
|code|int32|required|Response code, return 200 if OK or return 10000X if Exception| 
|msg|string|required|Interpretation of return code|
|count|uint64|required| Total number of log items|


LogPodCountRequest

|Parameter | Type |Need| Description |
|:-----|:-----|:-----|:-----|
|req_id|string|optional|Unique request id,stored in gRPC metadata field ankr_req_id |
|pod_name|string|required|Pod Name generated by Deployment Pod|
|keywords|[]string|optional|keywords log item contains,such as error|
|start_time|uint64|required|start time of log, measured by second from UTC(zero time zone)|
|end_time|uint64|required|end time of log, measured by second from UTC(zero time zone)|
|is_test|bool|optional|When true, test API whether it is available or not|

LogPodCountResponse

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|required|Corresponding to request, default value Unknown|
|code|int32|required|Response code, return 200 if OK or return 10000X if Exception| 
|msg|string|required|Interpretation of return code|
|count|uint64|required| Total number of log items|

* ListLogByAppId

LogAppRequest

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|optional|Unique request id,stored in gRPC metadata field ankr_req_id |
|app_id|string|required|AppID generated and managed by appmgr|
|keywords|[]string|optional|keywords log item contains,such as error|
|start_time|uint64|required|start time of log, measured by second from UTC(zero time zone)|
|end_time|uint64|required|end time of log, measured by second from UTC(zero time zone)|
|search_after|uint64|required|Pass 0 for first time query, pass last return value of last_search_end util get all log items|
|size|uint32|required|Max count of response log items(**Threshold: 500**)|
|sort|string|optional|Log items ordered by desc or asc, default desc|
|is_test|bool|optional|When true, test API whether it is available or not|

LogAppResponse

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|required|Corresponding to request, default value Unknown|
|code|int32|required|Response code, return 200 if OK or return 10000X if Exception| 
|msg|string|required|Interpretation of return code|
|total_count|uint64|required|Total number of log items statisfied with request requirement|
|last_search_end|uint64|required|Endpoint of log items in current request|
|log_details|[]LogEntry|required|Log items and pod metadata group by pod name|

* ListLogByPodName

LogPodRequest

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|optional|Unique request id,stored in gRPC metadata field ankr_req_id |
|pod_name|string|required|Pod name generate Deployment Pod|
|keywords|[]string|optional|keywords log item contains,such as error|
|start_time|uint64|required|start time of log, measured by second from UTC(zero time zone)|
|end_time|uint64|required|end time of log, measured by second from UTC(zero time zone)|
|search_after|uint64|required|Pass 0 for first time query, pass last return value of last_search_end util get all log items|
|size|uint32|required|Max count of response log items(**Threshold: 500**)|
|sort|string|optional|Log items ordered by desc or asc, default desc|
|is_test|bool|optional|When true, test API whether it is available or not|

LogPodResponse

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|required|Corresponding to request, default value Unknown|
|code|int32|required|Response code, return 200 if OK or return 10000X if Exception| 
|msg|string|required|Interpretation of return code|
|total_count|uint64|required|Total number of log items statisfied with request requirement|
|last_search_end|uint64|required|Endpoint of log items in current request|
|log_details|LogEntry|required|Log items and pod metadata|

LogEntry

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|meta_data|LogMetaData|required|Meta data of pod|
|log_items|[]LogItem|required|Log details|

LogMetaData

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|pod_name|string|required|Pod name|
|pod_id|string|required|Pod ID|
|namespace_name|string|required|Namespace name|
|namespace_id|string|required|Namespace ID|

LogItem

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|timestamp|string|required|Log record timestamp|
|msg|string|required|Log content|

## Example

For example, we want to display a pod(dccn-erc20-monitor-6d6fdbf687-kzfdf) log containing keyword error  in last two days, 
10 per request and sorted by asc.

* Step 1

Get total log count

**Request**

json format

```
{
  "req_id": "",
  "pod_name": "dccn-erc20-monitor-6d6fdbf687-kzfdf",
  "keywords": [
    "error"
  ],
  "start_time": 1560591337,
  "end_time": 1560764137
}
```

**Response**

json format

```
{
  "req_id": "req-001",
  "code": 200,
  "msg": "SUCCESS",
  "count": 64
}
```

* Step 2

According to total log count, we should send 7(ceil(64/10)) times query requests to get all log items.
Get log details without search_after for first time.

**Request**

```
{
  "req_id": "",
  "pod_name": "dccn-erc20-monitor-6d6fdbf687-kzfdf",
  "keywords": [
    "error"
  ],
  "start_time": 1560591337,
  "end_time": 1560764137
  "size": 10
}
```

**Response**

```
{
  "req_id": "req-001",
  "code": 200,
  "total_count": 64,
  "last_search_end": 1560724536116,
  "log_details": {
    "meta_data": {
      "pod_name": "dccn-erc20-monitor-6d6fdbf687-kzfdf",
      "pod_id": "d647bd22-9031-11e9-b5ef-06810cbb0e0a",
      "namespace_name": "default",
      "namespace_id": "f7cebe82-108b-11e9-a5fa-0661f96854a6"
    },
    "log_items": [
      {
        "timestamp": "2019-06-17T01:45:36.115770548+00:00",
        "msg": "time=\"2019-06-17T01:45:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:40670-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-17T01:25:36.118228296+00:00",
        "msg": "time=\"2019-06-17T01:25:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:37770-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-17T01:05:36.115896261+00:00",
        "msg": "time=\"2019-06-17T01:05:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:34990-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-17T00:45:36.116277971+00:00",
        "msg": "time=\"2019-06-17T00:45:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:60496-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-17T00:25:36.115793257+00:00",
        "msg": "time=\"2019-06-17T00:25:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:52120-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-17T00:05:36.115746419+00:00",
        "msg": "time=\"2019-06-17T00:05:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:47690-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T23:45:36.115765405+00:00",
        "msg": "time=\"2019-06-16T23:45:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:41026-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T23:15:36.115771214+00:00",
        "msg": "time=\"2019-06-16T23:15:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:37004-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T22:55:36.115905251+00:00",
        "msg": "time=\"2019-06-16T22:55:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:34406-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T22:35:36.116264990+00:00",
        "msg": "time=\"2019-06-16T22:35:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:60000-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      }
    ]
  }
}

```


* Step 3

Get log details with search_after value using last_search_end value

**Request**

```
{
  "req_id": "",
  "pod_name": "dccn-erc20-monitor-6d6fdbf687-kzfdf",
  "keywords": [
    "error"
  ],
  "start_time": 1560591337,
  "end_time": 1560764137
  "search_after": 1560724536116,
  "size": 10
}
```

**Response**

```
{
  "req_id": "req-001",
  "code": 200,
  "total_count": 64,
  "last_search_end": 1560712536116,
  "log_details": {
    "meta_data": {
      "pod_name": "dccn-erc20-monitor-6d6fdbf687-kzfdf",
      "pod_id": "d647bd22-9031-11e9-b5ef-06810cbb0e0a",
      "namespace_name": "default",
      "namespace_id": "f7cebe82-108b-11e9-a5fa-0661f96854a6"
    },
    "log_items": [
      {
        "timestamp": "2019-06-16T22:15:36.115669172+00:00",
        "msg": "time=\"2019-06-16T22:15:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:57428-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T21:55:36.115754487+00:00",
        "msg": "time=\"2019-06-16T21:55:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:52706-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T21:35:36.115821406+00:00",
        "msg": "time=\"2019-06-16T21:35:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:45630-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T21:15:36.115801272+00:00",
        "msg": "time=\"2019-06-16T21:15:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:42958-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T20:55:36.132539565+00:00",
        "msg": "time=\"2019-06-16T20:55:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: dial tcp 134.209.51.194:8546: connect: connection refused\"\n"
      },
      {
        "timestamp": "2019-06-16T20:45:36.116832475+00:00",
        "msg": "time=\"2019-06-16T20:45:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:38656-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T20:25:36.115791691+00:00",
        "msg": "time=\"2019-06-16T20:25:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:34548-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T19:55:36.115810371+00:00",
        "msg": "time=\"2019-06-16T19:55:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:53446-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T19:35:36.116717278+00:00",
        "msg": "time=\"2019-06-16T19:35:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:50692-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      },
      {
        "timestamp": "2019-06-16T19:15:36.116300656+00:00",
        "msg": "time=\"2019-06-16T19:15:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:47910-\u003e134.209.51.194:8546: use of closed network connection\"\n"
      }
    ]
  }
}
```

* Step 4-8

Repeat Step 3 by changing search_after value with last_search_end and other fields unchanged 
to get remaining log items.

## Other
If you want to display log by AppID, please use GetLogCountByAppId and
ListLogByAppId API similar to the above procedure.








