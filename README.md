# dccn-logmgr

Wrap Elasticsearch API to provide log search service

# Note

Have fun and enjoy it, let's go!

# API Specification

* GetLogCountByAppId

LogAppCountRequest

|Parameter | Type |Need| Description |
|:-----|:-----|:-----|:-----|
|req_id|string|optional|Unique request id,stored in gRPC metadata field ankr_req_id |
|app_id|string|required|AppID generated and managed by appmgr|
|keywords|[]string|optional|keywords log item contains,such as error|
|start_time|uint64|required|start time of log, measured by second from UTC(zero time zone)|
|end_time|uint64|required|end time of log, measured by second from UTC(zero time zone)|
|is_test|bool|optional|when true, test API whether it is available or not|


LogAppCountResponse

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|required|Corresponding to request, default value Unknown|
|code|int32|required|Response code, return 200 if OK or return 10000X if Exception| 
|msg|string|required|Interpretation of return code|
|count|uint64|required| Total number of log items|


LogPodCountRequest

|Parameter | Type |Need| Description |
|:-----|:-----|:-----|:-----|
|req_id|string|optional|Unique request id,stored in gRPC metadata field ankr_req_id |
|pod_name|string|required|Pod Name generated by Deployment Pod|
|keywords|[]string|optional|keywords log item contains,such as error|
|start_time|uint64|required|start time of log, measured by second from UTC(zero time zone)|
|end_time|uint64|required|end time of log, measured by second from UTC(zero time zone)|
|is_test|bool|optional|When true, test API whether it is available or not|

LogPodCountResponse

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|required|Corresponding to request, default value Unknown|
|code|int32|required|Response code, return 200 if OK or return 10000X if Exception| 
|msg|string|required|Interpretation of return code|
|count|uint64|required| Total number of log items|

* ListLogByAppId

LogAppRequest

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|optional|Unique request id,stored in gRPC metadata field ankr_req_id |
|app_id|string|required|AppID generated and managed by appmgr|
|keywords|[]string|optional|keywords log item contains,such as error|
|start_time|uint64|required|start time of log, measured by second from UTC(zero time zone)|
|end_time|uint64|required|end time of log, measured by second from UTC(zero time zone)|
|search_after|uint64|required|Pass 0 for first time query, pass last return value of last_search_end util get all log items|
|size|uint32|required|Max count of response log items(**Threshold: 500**)|
|sort|string|optional|Log items ordered by desc or asc, default desc|
|is_test|bool|optional|When true, test API whether it is available or not|

LogAppResponse

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|required|Corresponding to request, default value Unknown|
|code|int32|required|Response code, return 200 if OK or return 10000X if Exception| 
|msg|string|required|Interpretation of return code|
|total_count|uint64|required|Total number of log items statisfied with request requirement|
|last_search_end|uint64|required|Endpoint of log items in current request|
|log_items|[]LogItem|required|Log items and pod metadata|

* ListLogByPodName

LogPodRequest

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|optional|Unique request id,stored in gRPC metadata field ankr_req_id |
|pod_name|string|required|Pod name generate Deployment Pod|
|keywords|[]string|optional|keywords log item contains,such as error|
|start_time|uint64|required|start time of log, measured by second from UTC(zero time zone)|
|end_time|uint64|required|end time of log, measured by second from UTC(zero time zone)|
|search_after|uint64|required|Pass 0 for first time query, pass last return value of last_search_end util get all log items|
|size|uint32|required|Max count of response log items(**Threshold: 500**)|
|sort|string|optional|Log items ordered by desc or asc, default desc|
|is_test|bool|optional|When true, test API whether it is available or not|

LogPodResponse

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|req_id|string|required|Corresponding to request, default value Unknown|
|code|int32|required|Response code, return 200 if OK or return 10000X if Exception| 
|msg|string|required|Interpretation of return code|
|total_count|uint64|required|Total number of log items statisfied with request requirement|
|last_search_end|uint64|required|Endpoint of log items in current request|
|log_items|[]LogItem|required|Log items and pod metadata|

LogItem

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|meta_data|LogMetaData|required|Meta data of pod|
|timestamp|string|required|Log record timestamp|
|msg|string|required|Log record content|

LogMetaData

|Parameter | Type |Need | Description |
|:-----|:-----|:-----|:-----|
|pod_name|string|required|Pod name|
|pod_id|string|required|Pod ID|
|namespace_name|string|required|Namespace name|
|namespace_id|string|required|Namespace ID|

## Example

For example, we want to display an app(app-843ceaed-ddf2-4398-a2a2-010814854de4) log containing keyword error  in last two days, 
10 per request and sorted by asc.

**Note**: Just for show log request and response format, please replace the real app_id, start_time and end_time parameters 
you want to search.

* Step 1

Get total log count

**Request**

JSON format

```
{
  "req_id": "",
  "app_id": "app-843ceaed-ddf2-4398-a2a2-010814854de4",
  "keywords": [
    "error"
  ],
  "start_time": 1560591337,
  "end_time": 1560764137
}
```

**Response**

JSON format

```
{
  "req_id": "req-001",
  "code": 200,
  "msg": "SUCCESS",
  "count": 64
}
```

* Step 2

According to total log count, we should send 7(ceil(64/10)) times query requests to get all log items.
Get log details without search_after for first time.

**Request**

```
{
  "req_id": "",
  "app_id": "app-843ceaed-ddf2-4398-a2a2-010814854de4",
  "keywords": [
    "error"
  ],
  "start_time": 1560591337,
  "end_time": 1560764137
  "size": 10
}
```

**Response**

```
{
  "req_id": "req-001",
  "code": 200,
  "total_count": 64,
  "last_search_end": 1560724536116,
  "log_items": [
  {
    "meta_data": {
      "pod_name": "app-843ceaed-ddf2-4398-a2a2-010814854de4-wordpress-767df69qqpj4",
      "pod_id": "d647bd22-9031-11e9-b5ef-06810cbb0e0a",
      "namespace_name": "default",
      "namespace_id": "f7cebe82-108b-11e9-a5fa-0661f96854a6"
    },
    "timestamp": "2019-06-17T01:45:36.115770548+00:00",
    "msg": "time=\"2019-06-17T01:45:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:40670-\u003e134.209.51.194:8546: use of closed network connection\"\n"
  }, {
    "meta_data": {
      "pod_name": "app-843ceaed-ddf2-4398-a2a2-010814854de4-wordpress-767df69qqpj4",
      "pod_id": "d647bd22-9031-11e9-b5ef-06810cbb0e0a",
      "namespace_name": "default",
      "namespace_id": "f7cebe82-108b-11e9-a5fa-0661f96854a6"
    },
    "timestamp": "2019-06-17T01:35:36.115770548+00:00",
    "msg": "time=\"2019-06-17T01:35:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:40670-\u003e134.209.51.194:8546: use of closed network connection\"\n"
  },
  ....
  ]
}

```


* Step 3

Get log details with search_after value using last_search_end value

**Request**

```
{
  "req_id": "",
  "app_id": "app-843ceaed-ddf2-4398-a2a2-010814854de4-wordpress-767df69qqpj4",
  "keywords": [
    "error"
  ],
  "start_time": 1560591337,
  "end_time": 1560764137
  "search_after": 1560724536116,
  "size": 10
}
```

**Response**

```
{
  "req_id": "req-001",
  "code": 200,
  "total_count": 64,
  "last_search_end": 1560712536116,
  "log_items": [
  {
    "meta_data": {
      "pod_name": "app-843ceaed-ddf2-4398-a2a2-010814854de4-wordpress-767df69qqpj4",
      "pod_id": "d647bd22-9031-11e9-b5ef-06810cbb0e0a",
      "namespace_name": "default",
      "namespace_id": "f7cebe82-108b-11e9-a5fa-0661f96854a6"
    },
    "timestamp": "2019-06-16T22:15:36.115669172+00:00",
    "msg": "time=\"2019-06-16T22:15:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:57428-\u003e134.209.51.194:8546: use of closed network connection\"\n"
  },
  {
    "meta_data": {
      "pod_name": "app-843ceaed-ddf2-4398-a2a2-010814854de4-wordpress-767df69qqpj4",
      "pod_id": "d647bd22-9031-11e9-b5ef-06810cbb0e0a",
      "namespace_name": "default",
      "namespace_id": "f7cebe82-108b-11e9-a5fa-0661f96854a6"
    },
    "timestamp": "2019-06-16T21:35:36.115821406+00:00",
    "msg": "time=\"2019-06-16T21:35:36Z\" level=error msg=\"keepWSConnectionCycle, get the latest block error: write tcp 100.96.1.58:45630-\u003e134.209.51.194:8546: use of closed network connection\"\n"
  },
  ...
]
}

```

* Step 4-8

Repeat Step 3 by changing search_after value with last_search_end and leave other fields unchanged 
to get remaining log items.

## Other

If you want to display log by PodName, please use GetLogCountByPodName and
ListLogByPodName API similar to the above procedure.








